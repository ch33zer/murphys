<!DOCTYPE html>

<head>
    <title>Telephone</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
    <style>
        span.size-500 {
            font-size: 500px;
            font-variation-settings: 'OPSZ' 500;
        }
    </style>
    <script>
        let listening = false;
        let recognition;
        function setup() {
            const synth = window.speechSynthesis;
            let voice = null;
            synth.onvoiceschanged = () => {
                const voices = synth.getVoices();
                for (let i = 0; i < voices.length; i++) {
                    if (voices[i].default) {
                        voice = voices[i];
                        return
                    }
                }
                throw "Unable to find default voice"
            };
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = "en-US";
            recognition.interimResults = false;
            recognition.continuous = true;
            recognition.maxAlternatives = 1;
            for (const eventtype of ['audiostart', 'audioend', 'end', 'error', 'nomatch', 'result', 'soundstart', 'soundend', 'speechstart', 'speechend', 'start']) {
                recognition.addEventListener(eventtype, (e) => {
                    console.log("[GLOBAL] recognition", eventtype, e);
                });
            }
            recognition.start();

            const startButton = document.querySelector("#startButton");
            const welcomeScreen = document.querySelector("#welcome")
            const listenScreen = document.querySelector("#listen")
            function listen() {
                listening = true;
                return new Promise((resolve, reject) => {
                    console.log("Listen promise")
                    function removeAllListeners() {
                        listening = false;
                        recognition.removeEventListener('result', listenResultCb);
                        recognition.removeEventListener('error', listenErrorCb);
                        recognition.removeEventListener('nomatch', listenMatchCb);
                    }
                    function listenResultCb(e) {
                        console.log("listen result:", e)
                        removeAllListeners()
                        resolve(getRecognition(e))
                    }
                    function listenErrorCb(e) {
                        console.log("listen error:", e)
                        removeAllListeners()
                        reject(e);
                    }
                    function listenMatchCb(e) {
                        console.log("listen nomatch:", e)
                        removeAllListeners()
                        reject(e);
                    }
                    recognition.addEventListener('result', listenResultCb);
                    recognition.addEventListener('error', listenErrorCb)
                    recognition.addEventListener('nomatch', listenMatchCb)
                })
            }
            function wait(wait) {
                return new Promise((resolve) => {
                    setTimeout(resolve, wait)
                })
            }
            function say(txt) {
                return new Promise((resolve) => {
                    console.log("Say promise")
                    const utterThis = new SpeechSynthesisUtterance(txt);
                    utterThis.addEventListener('end', (e) => {
                        console.log("say end", e)
                        resolve(e)
                    })
                    utterThis.voice = voice;
                    synth.speak(utterThis);
                });
            }
            function getRecognition(recognitionEvent) {
                return recognitionEvent.results[recognitionEvent.resultIndex][0].transcript.trim()
            }
            async function runFor(txt, rounds) {
                for (let i = 0; i < rounds; i++) {
                    console.log(i, "Pre-promise")
                    await Promise.all([wait(1000).then(() => say(txt)), listen()]).then((res) => {
                        console.log("Got back", res)
                        const [ignore, newtxt] = res
                        if (newtxt.length != 0) {
                            txt = newtxt;
                        }
                    })
                    // Things just seem to work better if we give the API more time to react...
                    console.log(i, "Waiting post resolution")
                    await wait(1000)
                }
            }
            document.querySelector("#startButton").onclick = () => {
                listenScreen.hidden = false
                welcomeScreen.hidden = true
                listen().then((text) => runFor(text, 5))
            }
        }
        window.addEventListener('load', setup)
    </script>
</head>

<body>
    <div id="welcome" class="container mt-3 text-center">
        <div class="row">
            <div class="col">
                <i class="bi bi-mic" style="font-size: 300px;"></i>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <p>Let's play telephone! On the next page say a phrase. You voice will be routed through your browser's
                    speech to text engine, then through your browsers text to speech engine over the speakers, then
                    through your browsers
                    speech to text engine, etc. This will happen 5 times. You can either let it play out or you can
                    interfere by making noise while the text is being spoken. Make sure to accept the microphone
                    permission prompt from your browser above and unplug your headphones so the mic can pick up the
                    audio.</p>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <button id="startButton" type="button" class="btn btn-primary">
                    Continue
                    <i class="bi bi-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>
    <div id="listen" class="container mt-3 text-center" hidden>
        <div class="row">
            <div class="col">
                <i class="bi bi-mic" style="font-size: 300px;"></i>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <p>Speak now!</p>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <button id="startButton" type="button" class="btn btn-primary">
                    Continue
                    <i class="bi bi-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>
    <div id="speak" class="container mt-3" hidden>
        <div class="row">
            <div class="col">
                <i class="bi bi-chat-text" style="font-size: 300px;"></i>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <p>I heard: <b id="heardText"></b></p>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <p>Speak now!</p>
            </div>
        </div>
    </div>
</body>